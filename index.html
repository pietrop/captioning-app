<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Captions Maker</title>

  <!-- Latest compiled and minified CSS -->
  <!-- TODO: move to local folder -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/paper/bootstrap.min.css" >
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://www.youtube.com/iframe_api"></script>
 
  </head>
  <body>



<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Captions Maker</a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
    
      <form class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input type="text" id="videoYoutubeUrlInput" class="form-control" placeholder="Add Youtube URL" value="https://youtu.be/k_HZczxGfnY" >
          <!--  https://youtu.be/pWZAF3j_jA4  https://youtu.be/CrpkZkwTvu0 -->
        </div>
        <button type="submit" id="loadYoutubeUrlBtn" class="btn btn-primary">Load</button>

      </form>
      <ul class="nav navbar-nav">
        <form class="navbar-form navbar-left" role="search">
          <a  id="selectFileBtn" class="btn btn-primary">Select file</a>
        </form>
            <!--  <li><a href="#">Link</a></li> -->
      </ul>
      <ul class="nav navbar-nav navbar-right">
       <!-- li -->
      </ul>
    </div>
  </div>
</nav>

<div class="container" >
  <div class="row">
    <div class="col-xs-12 col-sm-3  col-md-3  col-lg-3">
      <!-- <label for="select" class="control-label">Video preview</label> -->
      <!-- <a  id="selectFileBtn" class="btn btn-primary btn-xs ">Select file</a> -->
         <!-- <br><br> -->
      <div id="videoPreview" class="embed-responsive embed-responsive-16by9">
      </div>

<br><br>
      <div id="demoNoticeDiv"></div>


    <!--   <div id="player"></div> -->
    </div>
    <div class="col-xs-12 col-sm-7  col-md-7  col-lg-7">
      <!-- <label for="select" class="control-label">Text</label> -->
      <div id="textBox"  class="form-control"  contenteditable="true"></div>
    </div>
    <div class="col-xs-12 col-sm-2  col-md-2  col-lg-2">
      <!-- Info -->

 <div class="form-group">
       <a id="installAeneas" class="btn btn-default btn-xs" href="https://github.com/sillsdev/aeneas-installer/releases" target="_blank">Install Aneneas aligner</a>
        <a id="alignBtn" class="btn btn-primary btn-xs" href="#">Align</a>
        <a id="exportSrtBtn" class="btn btn-primary btn-xs" href="#">Export</a>
 </div>
      <div class="checkbox">
        <label>
          <input id="checkboxInput" type="checkbox" > <small>Pause video while typing </small>
        </label>
      </div>
       <label for="inputEmail" class="control-label">Head Tail</label>
       <input type="text" class="form-control" id="inputHeadTail" placeholder="head tail" value="00:00:00,000" disabled>
       <label for="inputEmail" class=" control-label">End Tail</label>
       <input type="text" class="form-control" id="inputEndTail" placeholder="End tail" value="00:00:00,000" disabled>
       <!-- <a id="searchBtn" class="btn btn-default btn-xs" href="#">search</a> -->

<div class="form-group">
  <!-- Espeek languages http://espeak.sourceforge.net/languages.html -->
      <label for="select" class=" control-label">Languages for alignement</label>
        <select class="form-control" id="select" disabled>
          <option value="eng">English</option>
          <option value="it">Italian</option>
          <option value="af">  Afrikaans </option>
          <option value="bs">  Bosnian </option>
          <option value="ca">  Catalan </option>
          <option value="cs">  Czech </option>
          <option value="da">  Danish </option>
          <option value="de">  German </option>
          <option value="el">  Greek </option>
          <option value="eo">  Esperanto </option>
          <option value="es">  Spanish </option>
          <option value="es-la">  Spanish - Latin America </option>
          <option value="fi">  Finnish </option>
          <option value="fr">  French </option>
          <option value="hr">  Croatian </option>
          <option value="hu">  Hungarian </option>
          <option value="lv">  Latvian </option>
          <option value="nl">  Dutch </option>
          <option value="pl">  Polish </option>
          <option value="pt">  Portuguese (Brazil) </option>
          <option value="pt-pt">  Portuguese (European) </option>
          <option value="ro">  Romanian </option>
          <option value="sk">  Slovak </option>
          <option value="sr">  Serbian </option>
          <option value="sv">  Swedish </option>
          <option value="sw">  Swahihi </option>
          <option value="ta">  Tamil </option>
          <option value="tr">  Turkish </option>
          <option value="zh">  Mandarin Chinese </option>
        </select>
    </div>





    </div>
  </div>
</div>

<style>
#textBox{
  width: 100%;
  height: 85vh;
  overflow: scroll;
  background: #fff;
  box-shadow: 0 0 10px #ccc;
  padding: 50px;
}
body{
      background: #f1f1f1;
}
</style>

 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" ></script>
<!-- ./node_modules/bootstrap/dist/js/bootstrap.min.js -->
</body>
    <!-- All of the Node.js APIs are available in this renderer process. -->
  <script>
    // You can also require other files to run in this process
    if(window.process!=undefined){
      require('./renderer.js')
    }else{
      // run demo code. 
//////////////////////////////////////////////////////////
// demo notice
var demoNotice =`<div class="alert alert-dismissible alert-warning">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <h4>Dummy Demo!</h4>
  <p>This is a dummy demo of the app, not all the feature work, and it's for demonstratioon purposes only, it is not a web app. click on <b>load</b> and then <b>align</b> for a demonstration of what the app can do.
  For any questions feel free to get in touch, via <a href="mailto:pietro.passarelli@gmail.com">email</a> or <a href="https://twitter.com/pietropassarell" target="_blank">@pietropassarell</a></p>
</div>`;

document.getElementById('demoNoticeDiv').innerHTML = demoNotice;
      // on click of youtube video load populate video player
      // populate with dummy text
      // Align populate with dummy srt text example
   
var alignBtnEl = document.getElementById('alignBtn');
var exportSrtBtnEl = document.getElementById('exportSrtBtn');
var selectFileBtnEl = document.getElementById('selectFileBtn');
var loadYoutubeUrlBtnEl = document.getElementById('loadYoutubeUrlBtn');
var videoYoutubeUrlInputEl = document.getElementById('videoYoutubeUrlInput');
var videoPreviewEl = document.getElementById('videoPreview');
var textBoxEl = document.getElementById('textBox');
var checkboxInputEl = document.getElementById('checkboxInput');

var isYoutubeVideo = true;
var timeout = null;
var resumeTiypingTimeInterval = 600;
var startStopPlayingVideoOntyping = false;


checkboxInputEl.onclick = function(e){
  // e.preventDefault();
  if(startStopPlayingVideoOntyping == false){
    startStopPlayingVideoOntyping = true;
  }else{
    startStopPlayingVideoOntyping = false;
  }
};


loadYoutubeUrlBtnEl.onclick = function(e){
  e.preventDefault();
  isYoutubeVideo = true;
  // disableTextEditorProgressMessage();
  var url = videoYoutubeUrlInputEl.value;
  //TODO: add validation to check it's a valid youtube URL.
  var youtubeId = youtubeUrlExtractId(url);
  populateYoutubePlayer(youtubeId);

  //TODO: can I use path .join here to add extension to name?
  // var destFileName = dataPath+"/"+ youtubeId+".mp4";
   // sourceVideoPath = destFileName;
  // downloadYoutubeVideo(url, function(destPath){
  //   sourceVideoPath = destPath;
  //   console.log("sourceVideoPath+ ",sourceVideoPath)
  
  //   downloadCaptions(url, function(captionFiles){
  //     if (captionFiles.length ==0){
  //       alert("This video has no captions");
  //     }else{
  //       var captionFile = captionFiles[0];
  //       console.log("1,openYoutubeVttFile");
  //       openYoutubeVttFile(path.join(dataPath,captionFile));
  //       // var captionsContent = openFile(captionFiles[0]);
        
  //       console.log(captionFile);
  //     }
  //   }); 
  // });
};

function youtubeUrlExtractId(url){
  var urlParts = url.split("/");
  var urlPartsLegth = urlParts.length;
  var youtubeId = urlParts[urlPartsLegth-1]
  return youtubeId;
}

function populateYoutubePlayer(id){
  console.log(id);
  //simple implementation 
  var youtubeElement = `<iframe id="youtubeIframe" width='560' height='315' class='embed-responsive-item' src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
  // var youtubeElement = `<video width="640" height="360"><source type="video/youtube" src="http://www.youtube.com/watch?v=${id}" /></video>`
  videoPreviewEl.innerHTML = youtubeElement;
  // document.querySelector( 'video' ).addEventListener("playing", checkIfTypingPause, false);
  document.getElementById('youtubeIframe').onload= function() {
    var iframe = document.querySelector('iframe');
    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    //start video 
    //TODO: decide whether to enable this or not. maybe make as an option?
    // innerDoc.querySelectorAll('video')[0].click();
    
    initializeVideoPlayPuaseTypingPreferences();
  };

  loadEditorEith(demoText);
}

function loadEditorEith(content){
    textBoxEl.innerText = content
}


alignBtnEl.onclick = function(){
  loadEditorEith(demoSrtContent)
  makeSrtTimeCodesIntoLinks()
  addLinksToSrtTimecodes()
}


 function makeSrtTimeCodesIntoLinks () {
    // console.log(textBoxEl.innerHTML);
    //http://pietropassarelli.com/regex.html
    textBoxEl.innerHTML = textBoxEl.innerHTML.replace(/(\d{2}[:|.]\d{2}[:|.]\d{2}[.|,|:]\d{3})/ig , function replace(match) { //(?!<)
        return '<a class="timecodeLink">' + match + '</a>'; 
    });
    //TODO: Move curson back to it's possition after replacement editable
    
    //add event listener on class name. 
    //https://stackoverflow.com/questions/19655189/javascript-click-event-listener-on-class
};




function addLinksToSrtTimecodes(){
  var timecodesEl = document.querySelectorAll('.timecodeLink');

  timecodesEl.forEach(function(element, index){
    element.onclick = function(){
      setVideoCurrentTime(element.innerText)
    }
  })
}

function setVideoCurrentTime(timecode){

  //convert timecode
  var time = convertTimeCodeToSeconds(timecode);
  
  if(isYoutubeVideo){
    var iframe = document.querySelector('iframe');
    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    // innerDoc.querySelectorAll('video')[0].click();
    innerDoc.querySelectorAll('video')[0].currentTime = time;
    playVideo();
  }
}

function convertTimeCodeToSeconds(timeString){

  var timeArray = timeString.split(":");

  var hours   = parseFloat(timeArray[0]) * 60 * 60;
  var minutes = parseFloat(timeArray[1]) * 60;
  var seconds = parseFloat(timeArray[2].replace(",","."));
  // var frames  = parseInt(timeArray[3].split(",")[1])*(1/framerate);
  // var str = "h:" + hours + "\nm:" + minutes + "\ns:" + seconds + "\nf:" + frames;
  // console.log(str);
  var totalTime = hours + minutes + seconds// + frames;

  //alert(timeString + " = " + totalTime)
  return totalTime;
}

function playVideo(){
  console.log("play video ");
  // document.querySelector( 'video' ).play();
  if(isYoutubeVideo){
    var iframe = document.querySelector('iframe');
    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;

    if(innerDoc.querySelectorAll('video')[0].src ==""){
      innerDoc.querySelectorAll('video')[0].click();
    }else{
      innerDoc.querySelectorAll('video')[0].play();
    }
    
  }
    
}

function pauseVideo(){
  if(isYoutubeVideo){
    var iframe = document.querySelector('iframe');
    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    // document.querySelector( 'video' ).pause();
    innerDoc.querySelectorAll('video')[0].pause();
  }
  
}


    var demoText =`Have you ever seen the bumper sticker that says the earth does not belong to us? We belong to the earth or maybe you've seen the one that says: save the planet kill yourself. These things are an expression of what we might call liberal environmentalism, and the basic idea behind liberal environmentalism is that mankind is bad for the planet. Now. This way of thinking about the natural world is countered by what we might think of as a kind of conservative environmentalism, although it's not usually called environmentalism where it's not so much that we belong to the earth, but but rather that the earth belongs to us. How does that look to the Orthodox Christian faith? Do we have anything to say about environmentalism? Do we have to pick either liberal environmentalism or conservative stewardship environmentalism? Well, I think we don't have to pick between those two and in fact we actually have a different vision in the Orthodox Church of what man's relationship to the natural world should be. I would say that both we and the earth belong to God. We are both creations of God, and everything is ultimately referred back to go. Man'S purpose is to offer the creation back to God for God's blessing, and then God blesses it and then returns it to man and that blesses men in turn. This is the basic narrative and dynamic of sacrifice on altars, the basic narrative and dynamic of all prayer of liturgical action and so forth, and so, rather than being an alien on the earth which is sort of the liberal environmental vision for mankind on the earth or Being the owner of the earth, which is a more kind of conservative approach to environmentalism, man is rather the priest of this earth. His job is to offer the natural world back up to God for that blessing, and so, if man is the priest, then what does that make the earth? The earth is actually a temple, a church, a cathedral, a cosmic Cathedral, and our purpose in this cosmic cathedral is to worship, God and to use the natural world as part of that worship and this approach to the natural world. This kind of reverence, because we see God as being present in all things - he is not identical with the world, but he is present in the world, the sense that God is present in all things, and so therefore we approach the world with a natural reverence. This idea, this sense, is something that a lot of the saints of the Orthodox Church have had throughout time, such as Saint Seraphim of Sarov and other Saints, who spent a lot of time outdoors and had a real connection with the natural world, seeing it as being Part of God's creation, just as they are part of God's creation, and that we don't belong to the earth. The earth does not belong to us, but we and the earth are the Lord's. You`


//TODO: replace with more accurate srt, with better chunking, once available.
    var demoSrtContent = `1
00:00:04,500 --> 00:00:06,560
[Birds Chirping]

2
00:00:06,560 --> 00:00:08,160
>>> Fr. Andrew Stephen Damick 
Have you ever seen the bumper sticker

3
00:00:08,160 --> 00:00:11,398
that says, "The Earth does not belong to us,
we belong to the Earth"?

4
00:00:12,480 --> 00:00:15,405
Or maybe you've seen the one
that says, "Save the planet,

5
00:00:15,405 --> 00:00:16,120
kill yourself".

6
00:00:17,520 --> 00:00:22,720
These things are an expression
of what we might call liberal environmentalism

7
00:00:22,720 --> 00:00:26,280
and the basic idea
behind liberal environmentalism

8
00:00:26,280 --> 00:00:29,360
is that mankind is bad for the planet.

9
00:00:29,360 --> 00:00:32,640
Now this way of thinking about
the natural world is countered

10
00:00:32,640 --> 00:00:36,720
by what we might think of as a
kind of conservative environmentalism

11
00:00:36,720 --> 00:00:40,640
although it's not usually called
environmentalism, where it's not so much

12
00:00:40,640 --> 00:00:44,480
that we belong to the Earth,
but rather that the Earth belongs to us.

13
00:00:44,659 --> 00:00:47,040
How does that look to the
Orthodox Christian faith?

14
00:00:47,040 --> 00:00:48,040
[Orthodox chanting]

15
00:00:48,040 --> 00:00:49,920
Do we have anything to say about
environmentalism.

16
00:00:49,920 --> 00:00:53,200
Do we have to pick either
liberal environmentalism

17
00:00:53,200 --> 00:00:57,080
or conservative stewardship environmentalism?

18
00:00:57,080 --> 00:01:00,354
Well I think we don't have to pick
between those two

19
00:01:00,354 --> 00:01:03,640
and in fact we actually have a different
vision in the Orthodox Church

20
00:01:03,640 --> 00:01:08,160
of what man's relationship to the natural
world should be.

21
00:01:08,160 --> 00:01:14,080
I would say that both we
and the Earth belong to God.

22
00:01:14,080 --> 00:01:18,080
We are both creations of God
and everything is ultimately

23
00:01:18,080 --> 00:01:26,680
referred back to God. 
Man's purpose is to offer the creation

24
00:01:26,680 --> 00:01:30,360
back to God for God's blessing
and then God blesses it

25
00:01:30,360 --> 00:01:35,120
and then returns it to man and that
blesses man in turn.

26
00:01:35,120 --> 00:01:38,960
This is the basic narrative
and dynamic of sacrifice on altars,

27
00:01:38,960 --> 00:01:42,127
the basic narrative and dynamic
of all prayer, of liturgical

28
00:01:42,127 --> 00:01:43,080
action and so forth.

29
00:01:43,760 --> 00:01:46,800
And so rather than being an
alien on the earth

30
00:01:46,800 --> 00:01:51,440
which is sort of the liberal environmental
vision for mankind on the earth

31
00:01:51,440 --> 00:01:55,840
or being the owner of the Earth
which is a more kind of conservative approach

32
00:01:55,840 --> 00:02:00,680
to environmentalism, man is rather
a priest of this Earth.

33
00:02:00,680 --> 00:02:04,902
His job is to offer the natural
world back up to God

34
00:02:04,902 --> 00:02:05,760
for that blessing.

35
00:02:06,280 --> 00:02:09,880
And so if man is the priest,
then what does that make the Earth?

36
00:02:09,880 --> 00:02:14,120
The Earth is actually a temple,
a church, a cathedral,

37
00:02:14,120 --> 00:02:15,920
a cosmic cathedral.

38
00:02:15,920 --> 00:02:17,960
And our purpose in this cosmic cathedral

39
00:02:17,960 --> 00:02:21,960
is to worship God and to use
the natural world as part of that worship.

40
00:02:22,520 --> 00:02:24,440
And this approach to the natural world,

41
00:02:24,440 --> 00:02:29,680
this kind of reverence because we see God
as being present in all things,

42
00:02:29,680 --> 00:02:34,000
He is not identical with the world, but he
is present in the world,

43
00:02:34,000 --> 00:02:36,000
the sense that God is present in all
things

44
00:02:36,000 --> 00:02:39,680
and so therefore approach the world
with a natural reverence, this idea,

45
00:02:39,680 --> 00:02:43,240
this sense is something that a lot of the
saints of the Orthodox Church

46
00:02:43,240 --> 00:02:45,200
have had throughout time, such as

47
00:02:45,200 --> 00:02:49,280
St. Seraphim of Sarov and other saints
who spent a lot of time outdoors

48
00:02:49,280 --> 00:02:50,600
and had a real connection

49
00:02:50,600 --> 00:02:53,480
with the natural world,
seeing it as being part

50
00:02:53,480 --> 00:02:57,520
of God's creation, just as they
are part of God's creation,

51
00:02:57,520 --> 00:03:00,560
and that we don't belong
to the Earth,

52
00:03:00,560 --> 00:03:02,160
the Earth does not belong
to us,

53
00:03:02,160 --> 00:03:06,040
but we and the Earth are the Lord's.`
    
    }
    
  </script>
</html>

<!-- <track kind="subtitles" label="English subtitles" src="subtitles_en.vtt" srclang="en" default></track> -->
